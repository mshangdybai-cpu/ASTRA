import streamlit as st
import openai
import time

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—à–∏—Ä–æ–∫–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞)
st.set_page_config(page_title="ASTRA AI - Space Mission", page_icon="üåå", layout="wide")

# ==========================================
# 1. –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–¢–ï–õ–ï–ú–ï–¢–†–ò–Ø –ò –°–¢–ê–¢–£–°)
# ==========================================
with st.sidebar:
    st.title("üë®‚ÄçüöÄ –°—Ç–∞—Ç—É—Å —ç–∫–∏–ø–∞–∂–∞")
    st.write("**–ö–æ—Å–º–æ–Ω–∞–≤—Ç:** –ê—Ä–∞–ª–±–∞–π –ê—è–≥”©–∑")
    st.divider()
    
    st.subheader("–ë–∏–æ–º–µ—Ç—Ä–∏—è")
    st.metric(label="–ñ“Ø—Ä–µ–∫ —Å–æ“ì—ã—Å—ã (–ü—É–ª—å—Å)", value="75 bpm", delta="-2 bpm")
    st.metric(label="–°—Ç—Ä–µ—Å—Å –¥–µ“£–≥–µ–π—ñ", value="“ö–∞–ª—ã–ø—Ç—ã (–ù–∏–∑–∫–∏–π)", delta="0%")
    st.metric(label="“ö–∞–Ω–¥–∞“ì—ã –æ—Ç—Ç–µ–≥—ñ (SpO2)", value="98%", delta="1%")
    
    st.divider()
    st.warning("‚ö†Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ —Å–≤—è–∑–∏ —Å –ó–µ–º–ª–µ–π: 20 –º–∏–Ω—É—Ç.")
    st.success("‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å ASTRA (–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º) –∞–∫—Ç–∏–≤–µ–Ω.")

# ==========================================
# 2. –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° ASTRA
# ==========================================
st.title("ASTRA: –ê–≤—Ç–æ–Ω–æ–º–¥—ã –ò–ò-–ø—Å–∏—Ö–æ–ª–æ–≥ üåå")
st.caption("–ö–æ–≥–Ω–∏—Ç–∏–≤—Ç—ñ-–º—ñ–Ω–µ–∑-“õ“±–ª—ã“õ —Ç–µ—Ä–∞–ø–∏—è—Å—ã (–ö–ú–¢) –Ω–µ–≥—ñ–∑—ñ–Ω–¥–µ–≥—ñ –∂“Ø–π–µ")

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ò–ò)
SYSTEM_PROMPT = """
–¢—ã ASTRA ‚Äî –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —ç–∫–∏–ø–∞–∂–∞.
–¢–≤–æ—è –±–∞–∑–∞: –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è —Ç–µ—Ä–∞–ø–∏—è (–ö–ú–¢).
–ó–∞–¥–∞—á–∞: –ø—Ä–æ—è–≤–ª—è—Ç—å —ç–º–ø–∞—Ç–∏—é, —Å–Ω–∏–º–∞—Ç—å —Å—Ç—Ä–µ—Å—Å, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏.
–û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∑–∞—Ö—Å–∫–∏–π, —Ä—É—Å—Å–∫–∏–π –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π).
"""

if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "system", "content": SYSTEM_PROMPT}]

# Quick Prompts (–ñ–µ–¥–µ–ª —Å“±—Ä–∞“õ—Ç–∞—Ä)
st.write("### Quick Prompts (–ñ–µ–¥–µ–ª —Å“±—Ä–∞“õ—Ç–∞—Ä):")
col1, col2 = st.columns(2)
with col1:
    if st.button("–°”ô–ª–µ–º, ASTRA. –ë“Ø–≥—ñ–Ω ”©–∑—ñ–º–¥—ñ –±—ñ—Ä—Ç“Ø—Ä–ª—ñ —Å–µ–∑—ñ–Ω—ñ–ø —Ç“±—Ä–º—ã–Ω..."):
        st.session_state.messages.append({"role": "user", "content": "–°”ô–ª–µ–º, ASTRA. –ë“Ø–≥—ñ–Ω ”©–∑—ñ–º–¥—ñ –±—ñ—Ä—Ç“Ø—Ä–ª—ñ —Å–µ–∑—ñ–Ω—ñ–ø —Ç“±—Ä–º—ã–Ω..."})
with col2:
    if st.button("–ü—Ä–∏–≤–µ—Ç, ASTRA. –ú–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?"):
        st.session_state.messages.append({"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç, ASTRA. –ú–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?"})

st.divider()

# ==========================================
# 3. –ê–ù–ê–õ–ò–ó –≠–ú–û–¶–ò–ô (SENTIMENT ANALYSIS)
# ==========================================
def analyze_sentiment(text):
    stress_markers_kz = ["—à–∞—Ä—à–∞–¥—ã–º", "“±–π“õ—ã–º –∫–µ–ª–º–µ–π–¥—ñ", "“õ–æ—Ä“õ—ã–Ω—ã—à", "–∂–∞–ª“ì—ã–∑–¥—ã“õ", "–±—ñ—Ä—Ç“Ø—Ä–ª—ñ"]
    stress_markers_ru = ["—É—Å—Ç–∞–ª", "—Ç—Ä–µ–≤–æ–≥–∞", "–¥–µ–ø—Ä–µ—Å—Å–∏—è", "—Å—Ç—Ä–∞—Ö", "–ø–ª–æ—Ö–æ", "–æ–¥–∏–Ω–æ–∫–æ"]
    
    text_lower = text.lower()
    for marker in stress_markers_kz + stress_markers_ru:
        if marker in text_lower:
            return True
    return False

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
for msg in st.session_state.messages:
    if msg["role"] != "system":
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

# ==========================================
# 4. –ú–£–õ–¨–¢–ò–ú–û–î–ê–õ–¨–ù–´–ô –í–í–û–î (–¢–µ–∫—Å—Ç, –§–∞–π–ª, –ì–æ–ª–æ—Å)
# ==========================================
# –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
prompt = st.chat_input("–•–∞–±–∞—Ä–ª–∞–º–∞ –∂–∞–∑—ã“£—ã–∑ / –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...")

# –í–≤–æ–¥ –∞—É–¥–∏–æ –∏ —Ñ–∞–π–ª–æ–≤ (–ø–æ–¥ —á–∞—Ç–æ–º)
with st.expander("üìé “ö–æ—Å—ã–º—à–∞ –µ–Ω–≥—ñ–∑—É –º“Ø–º–∫—ñ–Ω–¥—ñ–∫—Ç–µ—Ä—ñ (–ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–¥—ñ)"):
    audio_value = st.audio_input("–î–∞—É—ã—Å–ø–µ–Ω –µ–Ω–≥—ñ–∑—É (–ú–∏–∫—Ä–æ—Ñ–æ–Ω)")
    uploaded_file = st.file_uploader("–§–∞–π–ª —Ç—ñ—Ä–∫–µ—É (–ñ—É—Ä–Ω–∞–ª, –º–µ–¥–∏—Ü–∏–Ω–∞–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä)", type=["txt", "csv", "pdf"])

if prompt:
    # 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã —Å—Ç—Ä–µ—Å—Å–∞
    if analyze_sentiment(prompt):
        st.warning("‚ö†Ô∏è –ñ“Ø–π–µ —Å—Ç—Ä–µ—Å—Å –º–∞—Ä–∫–µ—Ä–ª–µ—Ä—ñ–Ω –∞–Ω—ã“õ—Ç–∞–¥—ã. –ö–ú–¢ –±–∞–∑–∞—Å—ã–Ω–∞–Ω –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è —Ö–∞—Ç—Ç–∞–º–∞—Å—ã –∂“Ø–∫—Ç–µ–ª—É–¥–µ...")
        time.sleep(1) # –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –±–∞–∑–µ (RAG)

    # 3. –û—Ç–≤–µ—Ç –ò–ò (–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å API –∫–ª—é—á –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã)
    openai.api_key = "–í–ê–®_API_–ö–õ–Æ–ß" 
    
    with st.chat_message("assistant"):
        try:
            # –î–ª—è –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:
            # response = openai.ChatCompletion.create(
            #     model="gpt-3.5-turbo",
            #     messages=
